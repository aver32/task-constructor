{% extends "base.html" %}
{% block title %}Вопросы: {{ test.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Вопросы теста: {{ test.title }}</h3>

    <div class="mb-3">
        <form method="post" id="questionForm">
            {% csrf_token %}
            {{ form.non_field_errors }}

            <!-- Отображаем номер вопроса (нередактируемый) -->
            <div class="mb-3">
                <label class="form-label">Порядковый номер</label>
                <input type="text" class="form-control" value="{{ next_order }}" readonly disabled>
                <small class="form-text text-muted">Номер присваивается автоматически</small>
            </div>

            <div class="mb-3">
                {{ form.question_text.label_tag }}
                {{ form.question_text }}
            </div>

            <div class="mb-3">
                {{ form.question_type.label_tag }}
                {{ form.question_type }}
            </div>

            <div class="mb-3">
                {{ form.points.label_tag }}
                {{ form.points }}
            </div>

            <!-- Блок для вариантов ответа -->
            <div id="optionsBlock" style="display:none;">
                <div class="mb-3">
                    {{ form.num_options.label_tag }}
                    {{ form.num_options }}
                    <small class="form-text text-muted">Укажите количество вариантов ответа (от 2 до 10)</small>
                </div>

                <h5>Варианты ответов</h5>
                <small class="form-text text-muted mb-2 d-block">Отметьте галочками правильные ответы</small>

                <div class="mb-2 option-row" data-option="1" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_1 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_1 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="2" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_2 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_2 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="3" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_3 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_3 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="4" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_4 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_4 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="5" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_5 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_5 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="6" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_6 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_6 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="7" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_7 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_7 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="8" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_8 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_8 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="9" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_9 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_9 }}</div>
                    </div>
                </div>

                <div class="mb-2 option-row" data-option="10" style="display:none;">
                    <div class="row align-items-center">
                        <div class="col-1">
                            <div class="form-check">{{ form.correct_10 }}</div>
                        </div>
                        <div class="col-11">{{ form.option_10 }}</div>
                    </div>
                </div>
            </div>

            <!-- Блок для текстового ответа -->
            <div id="textBlock" style="display:none;">
                <h5>Правильный ответ</h5>
                <div class="mb-2">{{ form.correct_text.label_tag }} {{ form.correct_text }}</div>
            </div>

            <!-- Блок для соотнесения -->
            <div id="matchingBlock" style="display:none;">
                <h5>Настройка соотнесения</h5>
                <div class="row">
                    <div class="col-md-5">
                        <h6>Левая колонка (утверждения)</h6>
                        <div class="mb-2">{{ form.left_1.label_tag }} {{ form.left_1 }}</div>
                        <div class="mb-2">{{ form.left_2.label_tag }} {{ form.left_2 }}</div>
                        <div class="mb-2">{{ form.left_3.label_tag }} {{ form.left_3 }}</div>
                        <div class="mb-2">{{ form.left_4.label_tag }} {{ form.left_4 }}</div>
                        <div class="mb-2">{{ form.left_5.label_tag }} {{ form.left_5 }}</div>
                    </div>
                    <div class="col-md-5">
                        <h6>Правая колонка (варианты)</h6>
                        <div class="mb-2">{{ form.right_A.label_tag }} {{ form.right_A }}</div>
                        <div class="mb-2">{{ form.right_B.label_tag }} {{ form.right_B }}</div>
                        <div class="mb-2">{{ form.right_C.label_tag }} {{ form.right_C }}</div>
                        <div class="mb-2">{{ form.right_D.label_tag }} {{ form.right_D }}</div>
                        <div class="mb-2">{{ form.right_E.label_tag }} {{ form.right_E }}</div>
                        <div class="mb-2">{{ form.right_F.label_tag }} {{ form.right_F }}</div>
                    </div>
                </div>

                <h6 class="mt-3">Правильные соответствия</h6>
                <small class="form-text text-muted d-block mb-2">Укажите букву правильного ответа для каждого утверждения</small>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">{{ form.match_1.label_tag }} {{ form.match_1 }}</div>
                        <div class="mb-2">{{ form.match_2.label_tag }} {{ form.match_2 }}</div>
                        <div class="mb-2">{{ form.match_3.label_tag }} {{ form.match_3 }}</div>
                        <div class="mb-2">{{ form.match_4.label_tag }} {{ form.match_4 }}</div>
                        <div class="mb-2">{{ form.match_5.label_tag }} {{ form.match_5 }}</div>
                    </div>
                </div>
            </div>

            <!-- Блок для матричного вопроса -->
            <div id="matrixBlock" style="display:none;">
                <h5>Настройка матричного вопроса</h5>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="mb-2">
                            {{ form.num_matrix_rows.label_tag }}
                            {{ form.num_matrix_rows }}
                            <small class="form-text text-muted">От 1 до 5 строк</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2">
                            {{ form.num_matrix_cols.label_tag }}
                            {{ form.num_matrix_cols }}
                            <small class="form-text text-muted">От 2 до 6 столбцов (A-F)</small>
                        </div>
                    </div>
                </div>

                <!-- ДОБАВЬТЕ ЭТОТ БЛОК -->
                <div class="mb-3">
                    <label class="form-label">{{ form.matrix_answer_type.label }}</label>
                    <div>
                        {% for radio in form.matrix_answer_type %}
                            <div class="form-check">
                                {{ radio.tag }}
                                <label class="form-check-label" for="{{ radio.id_for_label }}">
                                    {{ radio.choice_label }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <small class="form-text text-muted">
                        <strong>Один ответ:</strong> студент выбирает только одну ячейку в строке (радиокнопки)<br>
                        <strong>Несколько ответов:</strong> студент может выбрать несколько ячеек в строке (чекбоксы)
                    </small>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Строки (утверждения)</h6>
                        <div class="mb-2 matrix-row-field" data-row="1">{{ form.matrix_row_1.label_tag }} {{ form.matrix_row_1 }}</div>
                        <div class="mb-2 matrix-row-field" data-row="2">{{ form.matrix_row_2.label_tag }} {{ form.matrix_row_2 }}</div>
                        <div class="mb-2 matrix-row-field" data-row="3">{{ form.matrix_row_3.label_tag }} {{ form.matrix_row_3 }}</div>
                        <div class="mb-2 matrix-row-field" data-row="4">{{ form.matrix_row_4.label_tag }} {{ form.matrix_row_4 }}</div>
                        <div class="mb-2 matrix-row-field" data-row="5">{{ form.matrix_row_5.label_tag }} {{ form.matrix_row_5 }}</div>
                    </div>

                    <div class="col-md-6">
                        <h6>Колонки (варианты ответов)</h6>
                        <div class="mb-2 matrix-col-field" data-col="1">{{ form.matrix_col_A.label_tag }} {{ form.matrix_col_A }}</div>
                        <div class="mb-2 matrix-col-field" data-col="2">{{ form.matrix_col_B.label_tag }} {{ form.matrix_col_B }}</div>
                        <div class="mb-2 matrix-col-field" data-col="3">{{ form.matrix_col_C.label_tag }} {{ form.matrix_col_C }}</div>
                        <div class="mb-2 matrix-col-field" data-col="4">{{ form.matrix_col_D.label_tag }} {{ form.matrix_col_D }}</div>
                        <div class="mb-2 matrix-col-field" data-col="5">{{ form.matrix_col_E.label_tag }} {{ form.matrix_col_E }}</div>
                        <div class="mb-2 matrix-col-field" data-col="6">{{ form.matrix_col_F.label_tag }} {{ form.matrix_col_F }}</div>
                    </div>
                </div>

                <h6 class="mt-3">Правильные ответы</h6>
                <!-- ОБНОВИТЕ ТЕКСТ ПОДСКАЗКИ -->
                <small class="form-text text-muted d-block mb-2">
                    <strong>Для одного ответа:</strong> укажите одну букву (например: A)<br>
                    <strong>Для множественного:</strong> укажите буквы через запятую (например: A, B, D)
                </small>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2 matrix-answer-field" data-answer="1">{{ form.matrix_answer_1.label_tag }} {{ form.matrix_answer_1 }}</div>
                        <div class="mb-2 matrix-answer-field" data-answer="2">{{ form.matrix_answer_2.label_tag }} {{ form.matrix_answer_2 }}</div>
                        <div class="mb-2 matrix-answer-field" data-answer="3">{{ form.matrix_answer_3.label_tag }} {{ form.matrix_answer_3 }}</div>
                        <div class="mb-2 matrix-answer-field" data-answer="4">{{ form.matrix_answer_4.label_tag }} {{ form.matrix_answer_4 }}</div>
                        <div class="mb-2 matrix-answer-field" data-answer="5">{{ form.matrix_answer_5.label_tag }} {{ form.matrix_answer_5 }}</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary mt-3" type="submit">Добавить вопрос</button>
        </form>
    </div>

    <hr>

    <h4>Список текущих вопросов</h4>
    {% if questions %}
        <ul class="list-group">
            {% for q in questions %}
            <li class="list-group-item">
                <strong>{{ q.order_number }}. {{ q.question_text }}</strong>
                ({{ q.get_question_type_display }}, {{ q.points }} баллов)
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Вопросы пока не добавлены.</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionType = document.querySelector('select[name="question_type"]');
    const numOptionsInput = document.querySelector('#num_options');
    const numMatrixRowsInput = document.querySelector('#num_matrix_rows');  // ДОБАВЬТЕ
    const numMatrixColsInput = document.querySelector('#num_matrix_cols');  // ДОБАВЬТЕ
    const optionsBlock = document.querySelector('#optionsBlock');
    const textBlock = document.querySelector('#textBlock');
    const matchingBlock = document.querySelector('#matchingBlock');
    const matrixBlock = document.querySelector('#matrixBlock');
    const optionRows = document.querySelectorAll('.option-row');
    const matrixRowFields = document.querySelectorAll('.matrix-row-field');  // ДОБАВЬТЕ
    const matrixColFields = document.querySelectorAll('.matrix-col-field');  // ДОБАВЬТЕ
    const matrixAnswerFields = document.querySelectorAll('.matrix-answer-field');  // ДОБАВЬТЕ

    function updateFormFields() {
        const type = questionType.value;

        if (type === 'single_choice' || type === 'multiple_choice') {
            optionsBlock.style.display = 'block';
            textBlock.style.display = 'none';
            matchingBlock.style.display = 'none';
            matrixBlock.style.display = 'none';
            updateVisibleOptions();
        } else if (type === 'text_input' || type === 'number_input') {
            optionsBlock.style.display = 'none';
            textBlock.style.display = 'block';
            matchingBlock.style.display = 'none';
            matrixBlock.style.display = 'none';
        } else if (type === 'matching') {
            optionsBlock.style.display = 'none';
            textBlock.style.display = 'none';
            matchingBlock.style.display = 'block';
            matrixBlock.style.display = 'none';
        } else if (type === 'matrix') {
            optionsBlock.style.display = 'none';
            textBlock.style.display = 'none';
            matchingBlock.style.display = 'none';
            matrixBlock.style.display = 'block';
            updateVisibleMatrixFields();  // ДОБАВЬТЕ
        } else {
            optionsBlock.style.display = 'none';
            textBlock.style.display = 'none';
            matchingBlock.style.display = 'none';
            matrixBlock.style.display = 'none';
        }
    }

    function updateVisibleOptions() {
        const numOptions = parseInt(numOptionsInput.value) || 4;

        optionRows.forEach((row, index) => {
            const optionNum = parseInt(row.dataset.option);
            if (optionNum <= numOptions) {
                row.style.display = 'block';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // ДОБАВЬТЕ ЭТУ НОВУЮ ФУНКЦИЮ
    function updateVisibleMatrixFields() {
        const numRows = parseInt(numMatrixRowsInput.value) || 3;
        const numCols = parseInt(numMatrixColsInput.value) || 4;

        // Показываем/скрываем поля строк
        matrixRowFields.forEach((field) => {
            const rowNum = parseInt(field.dataset.row);
            if (rowNum <= numRows) {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });

        // Показываем/скрываем поля столбцов
        matrixColFields.forEach((field) => {
            const colNum = parseInt(field.dataset.col);
            if (colNum <= numCols) {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });

        // Показываем/скрываем поля ответов
        matrixAnswerFields.forEach((field) => {
            const answerNum = parseInt(field.dataset.answer);
            if (answerNum <= numRows) {
                field.style.display = 'block';
            } else {
                field.style.display = 'none';
            }
        });
    }

    questionType.addEventListener('change', updateFormFields);
    numOptionsInput.addEventListener('input', updateVisibleOptions);
    numMatrixRowsInput.addEventListener('input', updateVisibleMatrixFields);  // ДОБАВЬТЕ
    numMatrixColsInput.addEventListener('input', updateVisibleMatrixFields);  // ДОБАВЬТЕ

    // Инициализация при загрузке
    updateFormFields();
});
</script>
{% endblock %}